<link rel="import" href="../components/polymer/polymer.html">
<script src="../collectives/Collective.js"></script>

<script>
/*
 * Polymer 0.8 broke support for class inheritance. For now, we define an aspect
 * as a mixin.
 */

function mixin() {
  var result = {};
  for (var i in arguments) {
    var obj = arguments[i];
    for (var key in obj) {
      result[key] = obj[key];
    }
  }
  return result;
}

BasicAspectMixin = {

  assimilate: function(target) {
    this.collective.assimilate(target);
  },

  // attached: function() {
  //   console.log(this.localName + " attached");
  //   console.log(this._firstChildAspect());
  // },

  created: function() {
    new Collective(this);
  },

  // domReady: function() {
  //   console.log(this.localName + " domReady");
  // },

  properties: {
    target: {
      value: null,
      observer: 'targetChanged'
    }
  },

  targetChanged: function(target) {
    // console.log(this.localName + " targetChanged: " + target);
    // Handle special string value "child".
    // TODO: Handle "next".
    // TODO: Handle "shadow".
    var targetElement;
    if (target === 'child') {
      targetElement = this._firstChildAspect();
      if (!targetElement) {
        // Chances are, the element does have a child aspect, but it hasn't been
        // upgraded yet, so it's contribute key wasn't found.
        // HACK: Wait a tick and try again.
        // TODO: Figure out whether a better way to do this.
        setTimeout(function() {
          targetElement = this._firstChildAspect();
          if (targetElement) {
            this.assimilate(targetElement);
          }
        }.bind(this));
      }
    } else {
      targetElement = target;
    }
    if (targetElement) {
      this.assimilate(targetElement);
    }
  },

  // Return the first child with a "contribute" property.
  _firstChildAspect: function() {
    var children = Polymer.dom(this).children;
    var firstChildAspect;
    for (var i = 0, length = children.length; i < length; i++) {
      var child = children[i];
      if (child.contribute) {
        return child;
      }
    }
    return null;
  }

}

Polymer(mixin({

  contribute: {
    // The basic-aspect basic class contributes no members itself, but defines
    // a contribute property so that it (and any subclass) is recognizable as an
    // aspect.
  },

  is: 'basic-aspect'

}, BasicAspectMixin));
</script>
