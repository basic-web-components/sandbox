<link rel="import" href="../basic-aspect/basic-aspect.html">

<polymer-element name="basic-selection-aspect" extends="basic-aspect">
<script>
Polymer({

  contribute: {

    applySelection: function(item, selected) {
      // Default is to do nothing.
    },

    itemsChanged: function() {
      var selectedItem = this.selectedItem;
      var selectedItemFound = false;
      this.items.forEach(function(item) {
        var itemIsSelectedItem = (item === selectedItem);
        this.applySelection(item, itemIsSelectedItem);
        selectedItemFound = selectedItemFound || itemIsSelectedItem;
      }.bind(this));
      if (!selectedItemFound) {
        // Selected item is no longer in the current set of items.
        this.selectedItem = null;
      }
    },

    get selectedItem() {
      return this._selectedItem;
    },

    set selectedItem(item) {
      var previousItem = this._selectedItem;
      if (previousItem) {
        // Remove previous selection.
        this.applySelection(previousItem, false);
      }
      this._selectedItem = item;
      if (item) {
        this.applySelection(item, true);
      }

      // var event = new CustomEvent('selected-item-changed', {
      //   bubbles: true,
      //   detail: {
      //     selectedItem: item,
      //     previousItem: previousItem
      //   }
      // });
      // this.dispatchEvent(event);
    },

    /**
     * Return the index of the selected item, or -1 if there is no selection.
     */
    get selectedIndex() {
      var selectedItem = this.selectedItem;

      if (selectedItem == null) {
        return -1;
      }

      // TODO: Memoize
      var index = this.indexOfItem(selectedItem);

      // If index = -1, selection wasn't found. Most likely cause is that the
      // DOM was manipulated from underneath us.
      // TODO: Once we track content changes, turn this into an exception.
      return index;
    },

    set selectedIndex(index) {
      var items = this.items;
      var item;
      if (index < 0 || items.length === 0) {
        item = null;
      } else {
        index = Math.min(index, items.length);
        item = items[index];
      }
      this.selectedItem = item;
    },

    selectFirst: function() {
      this.selectedIndex = 0;
    },

    selectLast: function() {
      this.selectedIndex = this.items.length - 1;
    },

    selectNext: function() {
      var items = this.items;
      var length = items.length;
      var newIndex = this.selectedIndex + 1;
      if (newIndex < length) {
        this.selectedIndex = newIndex;
      }
    },

    selectPrevious: function() {
      var oldIndex = this.selectedIndex;
      if (oldIndex < 0) {
        // No selection.
        this.selectLast();
      } else {
        var newIndex = oldIndex - 1;
        if (newIndex >= 0) {
          this.selectedIndex = newIndex;
        }
      }
    }

  },

  _selectedItem: null

});
</script>
</polymer-element>
