<!--
Let the user swipe horizontally with swipe gesture or mouse.
-->

<link rel="import" href="basic-fractional-selection.html">

<polymer-element name="basic-swipe-selection" extends="basic-fractional-selection">
<template>
  <style>
  :host {
    touch-action: none;
  }
  </style>
<!--
  <style>
  :host {
    background: #f8f8f8;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-direction: column;
    flex-direction: column;
    overflow: hidden;
  }

  #swipeContainer {
    display: -webkit-flex;
    display: flex;
    -webkit-flex: 1;
    flex: 1;
    position: relative;
    touch-action: none;
    will-change: transform;
  }

  /*
  polyfill-next-selector {
    content: '#swipeContainer > *';
  }
  ::content > * {
    object-fit: contain;
    width: 100%;
    touch-action: none;
  }
  */

  </style>
  <div id="swipeContainer">
    <content></content>
  </div>
-->
</template>
<script>
Polymer({

  ready: function() {
    this.addEventListener('touchstart', function(event) {
      console.log('touchstart');
      this._touchStart(event.changedTouches[0].clientX);
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchmove', function(event) {
      this._touchMove(event.changedTouches[0].clientX);
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchend', function() {
      console.log('touchend');
      this._touchEnd(event.changedTouches[0].clientX);
      event.preventDefault();
    }.bind(this));
    // this.addEventListener('mousedown', function(event){
    //   console.log('mousedown');
    //   this._mouseDrag = true;
    //   this._touchStart(event.clientX);
    //   event.preventDefault();
    // });
    // this.addEventListener('mousemove', function(event){
    //   if (this._mouseDrag) {
    //     console.log('drag');
    //     this._touchMove(event.clientX);
    //   } else {
    //     console.log('mousemove');
    //   }
    // });
    // this.addEventListener('mouseup', function(event){
    //   console.log('mouseup');
    //   this._touchEnd(event.clientX);
    //   this._mouseDrag = false;
    // });
    // window.addEventListener('mousemove', function(event) {
    //   console.log('window mousemove');
    // });
    // window.addEventListener('mouseup', function() {
    //   console.log('window mouseup');
    // });

    // Default keyboard navigation (applies only when we have focus).
    this.addEventListener('keydown', this._keydown.bind(this));
  },

  snap: function(index) {
    this._showTransition(true);
    this.super([index]);
  },

  _keydown: function(event) {
    var handled;
    switch (event.which) { 
      case 37: // Left
        this.previous();
        handled = true;
        break;

      case 39: // Right
        this.next();
        handled = true;
        break;
    }
    if (handled) {
      event.stopPropagation();
    }
  },

  // TODO: Instead of needing to turn this off, listen for transitionEnd and
  // remove the showTransition class automatically.
  _showTransition: function(on) {
    this.classList.toggle('showTransition', on);
  },

  _touchStart: function(x) {
    this._showTransition(false);
    this._startX = x;
    this._startIndex = this.selectedIndex;
    this._previousX = x;
    this._delta = 0;
  },

  _touchMove: function(x) {
    this._trackTo(x);
  },

  _touchEnd: function(x) {
    if (this._delta >= 20) {
      // Finished going right at high speed.
      console.log("flick right " + this._delta);
      this.previous();
    } else if (this._delta <= -20) {
      // Finished going left at high speed.
      console.log("flick left " + this._delta);
      this.next();
    } else {
      // Finished at low speed.
      console.log("slow drag " + this._delta);
      // this._trackTo(x);
      this.snap();
    }
    this._delta = null;
  },

  _trackTo: function(x) {
    var width = this.offsetWidth;
    var dragDistance = this._startX - x;
    var fraction = width > 0 ?
      dragDistance / width :
      0;
    var index = this._startIndex + fraction;
    // this.selectedIndex = index;
    this._setSelectedIndex(index);
    this._delta = x - this._previousX;
    this._previousX = x;
  }

});
</script>
</polymer-element>
