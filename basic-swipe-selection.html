<!--
Let the user swipe horizontally with swipe gesture or mouse.
-->

<link rel="import" href="basic-fractional-selection.html">

<polymer-element name="basic-swipe-selection" extends="basic-fractional-selection">
<template>
  <style>
  :host {
    touch-action: none;
  }
  </style>
<!--
  <style>
  :host {
    background: #f8f8f8;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-direction: column;
    flex-direction: column;
    overflow: hidden;
  }

  #swipeContainer {
    display: -webkit-flex;
    display: flex;
    -webkit-flex: 1;
    flex: 1;
    position: relative;
    touch-action: none;
    will-change: transform;
  }

  /*
  polyfill-next-selector {
    content: '#swipeContainer > *';
  }
  ::content > * {
    object-fit: contain;
    width: 100%;
    touch-action: none;
  }
  */

  </style>
  <div id="swipeContainer">
    <content></content>
  </div>
-->
</template>
<script>
Polymer({

  ready: function() {
    this.addEventListener('touchstart', function(event) {
      console.log('touchstart');
      this._showTransition(false);
      this._startX = event.changedTouches[0].clientX;
      this._startIndex = this.selectedIndex;
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchmove', function(event) {
      this._trackTo(event.changedTouches[0].clientX);
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchend', function() {
      console.log('touchend');
      if (this._previousDeltaX >= 20) {
        // Finished going right at high speed.
        console.log("flick left " + this._previousDeltaX);
        this.next();
      } else if (this._previousDeltaX <= -20) {
        // Finished going left at high speed.
        console.log("flick right " + this._previousDeltaX);
        this.previous();
      } else {
        // Finished at low speed.
        this._trackTo(event.changedTouches[0].clientX);
        this.snap();
      }
      this._previousDeltaX = null;
      event.preventDefault();
    }.bind(this));
    this.addEventListener('mousedown', function(event){
      console.log('mousedown');
      event.preventDefault();
    });
    this.addEventListener('mousemove', function(event){
      console.log('mousemove');
    });
    this.addEventListener('mouseup', function(event){
      console.log('mouseup');
    });
  },

  selectedIndexChanged: function() {
    this.super();
    // console.log(this.selectedIndex);
  },

  snap: function(index) {
    this._showTransition(true);
    this.super([index]);
  },

  _trackTo: function(x) {
    var width = this.offsetWidth;
    var deltaX = this._startX - x;
    var fraction = width > 0 ?
      deltaX / width :
      0;
    var index = this._startIndex + fraction;
    this.selectedIndex = index;
    // TODO: Reincorporate this
    // var deltaX = this._previousX ? x - this._previousX : 0;
    // this._panTo(this._offset + deltaX);
    // this._previousX = x;
    this._previousDeltaX = deltaX;
  },

  // TODO: Instead of needing to turn this off, listen for transitionEnd and
  // remove the showTransition class automatically.
  _showTransition: function(on) {
    this.classList.toggle('showTransition', on);
  }


});
</script>
</polymer-element>
