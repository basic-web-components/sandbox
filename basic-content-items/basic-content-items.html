<!--
Aspect for treating aspect children as list items.

TODO: The itemsChanged handler only works if this is the innermost aspect.
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../BasicWebComponents/BasicWebComponents.html">

<polymer-element name="basic-content-items">
<script>
Polymer(BasicComposition.compose(
  {

    attached: function() {
      // HACK: Need to wait for collective to be created before invoking initial
      // contentChanged call.
      // TODO: Move to collectiveChanged?
      setTimeout(function() {
        this.contentChanged();
      }.bind(this));
    },

    contentChanged: function() {
      if (this.itemsChanged) {
        this.itemsChanged();
      }
    },

    contribute: {

      applySelection: function(item, selected) {
        item.classList.toggle('selected', selected);
      },

      contentChildrenChanged: function() {
        // TODO: Nullify memoized results.
      },

      /*
       * Return the index of the indicated item.
       */
      indexOfItem: function(item) {

        // TODO: Can we just use indexOf()?
        // return this.items.indexOf(item);

        if (item == null) {
          return -1; // By definition
        }
        var items = this.items;
        for (var i = 0, length = items.length; i < length; i++) {
          if (items[i] === item) {
            return i; // Found
          }
        }
        return -1; // Not found
      },

      get items() {
        // TODO: Memoize
        // TODO: Filter out auxiliary content.
        // TODO: flatten children.
        // TODO: property notifications so elements can bind to this property
        return this.collective.children;
      },

      itemsChanged: function() {}

    }

  },
  // HACK: Override BasicContent's MutationObserver so we don't pick up
  // attribute changes in content.
  Platform.mixin(BasicContent, {
    _observeContentChanges: function(node, handler) {
      node._contentChangeObserver = new MutationObserver(handler);
      node._contentChangeObserver.observe(node, {
        characterData: true,
        childList: true,
        subtree: true
      });
    }
  }),
  BasicWebComponents.Aspect
));
</script>
</polymer-element>
